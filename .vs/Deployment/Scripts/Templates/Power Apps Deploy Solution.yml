parameters:
- name: solutionName
  type: string
  default: ''
- name: powerPlatformServiceConnectionName
  type: string
  default: ''
- name: solutionParameterFileName
  type: string
  default: ''
- name: useSolutionParameterFile
  type: boolean
  default: true
- name: deploymentTypeVariableName
  type: string
  default: 'Update'

steps:
    - task: PowerPlatformImportSolution@2
      displayName: "Import Solution as Update"
      condition: eq(variables['${{parameters.deploymentTypeVariableName}}'], 'Update')      
      inputs:
        authenticationType: 'PowerPlatformSPN'
        PowerPlatformSPN: '${{ parameters.powerPlatformServiceConnectionName }}'
        SolutionInputFile: '$(Pipeline.Workspace)/Solutions/${{ parameters.solutionName }}_Managed.zip'
        AsyncOperation: true
        MaxAsyncWaitTime: '60'
        HoldingSolution: false
        UseDeploymentSettingsFile: ${{ parameters.useSolutionParameterFile }}
        DeploymentSettingsFile: '$(Pipeline.Workspace)/SolutionParameterFiles/${{ parameters.solutionParameterFileName }}'
        SkipLowerVersion: true

    - task: PowerPlatformImportSolution@2
      displayName: "Import Solution as Upgrade"
      condition: eq(variables['${{parameters.deploymentTypeVariableName}}'], 'Upgrade')      
      inputs:
        authenticationType: 'PowerPlatformSPN'
        PowerPlatformSPN: '${{ parameters.powerPlatformServiceConnectionName }}'
        SolutionInputFile: '$(Pipeline.Workspace)/Solutions/${{ parameters.solutionName }}_Managed.zip'
        AsyncOperation: true
        MaxAsyncWaitTime: '60'
        HoldingSolution: true
        UseDeploymentSettingsFile: ${{ parameters.useSolutionParameterFile }}
        DeploymentSettingsFile: '$(Pipeline.Workspace)/SolutionParameterFiles/${{ parameters.solutionParameterFileName }}'
        SkipLowerVersion: true


    - task: PowerPlatformApplySolutionUpgrade@2
      displayName: "Apply Solution Upgrade"
      condition: eq(variables['${{parameters.deploymentTypeVariableName}}'], 'Upgrade')
      inputs:
        authenticationType: 'PowerPlatformSPN'
        PowerPlatformSPN: '${{ parameters.powerPlatformServiceConnectionName }}'
        SolutionName: '${{ parameters.solutionName }}'
        AsyncOperation: true
        MaxAsyncWaitTime: '60'

  